<html>

<body>
    <canvas id="canvas" style="width: 100%; height: 100%"></canvas>
    <script type="text/javascript" src="../../dist/spark-engine-web.js"></script>
    <script>
        const context = document.getElementById('canvas').getContext('2d')
        const device = new SparkEngine.CanvasDevice();

        const renderer = new SparkEngine.Renderer(device);
        const renderSystem = new SparkEngine.RenderSystem(renderer);

        const physx = new SparkEngine.Physx();
        const physicsSystem = new SparkEngine.PhysicsSystem(physx);

        const inputs = new SparkEngine.KeyboardDevice();
        const inputSystem = new SparkEngine.InputSystem(inputs);

        const hierarchySystem = new SparkEngine.HierarchySystem();

        const baseColor = new SparkEngine.Rgb(0, 0, 0);
        const raquetteSpeed = 5;

        const leftRaquetteController = new SparkEngine.InputComponent();
        inputSystem.registerComponent(leftRaquetteController);

        const worldBoundingBox = new SparkEngine.StaticObject();
        worldBoundingBox.transform.size = { width: 300, height: 150 };
        worldBoundingBox.boundingBox.isContainer = true;
        worldBoundingBox.boundingBox.matchContainerTransform = true;
        worldBoundingBox.material.diffuseColor = new SparkEngine.Rgb(255, 0, 0);
        worldBoundingBox.material.opacity = 75;

        const leftRaquette = new SparkEngine.StaticObject();
        leftRaquette.transform.size = { width: 10, height: 30 };
        leftRaquette.transform.position.y = 60;
        leftRaquette.material.diffuseColor = baseColor;
        leftRaquette.boundingBox.matchContainerTransform = true;
        leftRaquette.addComponent(leftRaquetteController);

        leftRaquetteController.onInputEventCb = (({ code, status }) => {
            console.log('leftRaquetteController.onInputEventCb');

            const parentTransform = leftRaquetteController.getContainer().getComponent('TransformComponent');

            if (status === SparkEngine.KeyStatus.Down && code === 'KeyW') {
                parentTransform.velocity.y = -raquetteSpeed;
            } else if (status === SparkEngine.KeyStatus.Down && code === 'KeyS') {
                parentTransform.velocity.y = raquetteSpeed;
            } else {
                parentTransform.velocity.y = 0;
            }
        });

        const rightRaquetteController = new SparkEngine.InputComponent();
        inputSystem.registerComponent(rightRaquetteController);

        const rightRaquette = new SparkEngine.StaticObject();
        rightRaquette.transform.size = { width: 10, height: 30 };
        rightRaquette.transform.position = new SparkEngine.Vec2(290, 60);
        rightRaquette.material.diffuseColor = baseColor;
        rightRaquette.boundingBox.matchContainerTransform = true;
        rightRaquette.addComponent(rightRaquetteController);

        rightRaquetteController.onInputEventCb = (({ code, status }) => {
            console.log('rightRaquetteController.onInputEventCb');
            const parentTransform = rightRaquetteController.getContainer().getComponent('TransformComponent');

            if (status === SparkEngine.KeyStatus.Down && code === 'ArrowUp') {
                parentTransform.velocity.y = -raquetteSpeed;
            } else if (status === SparkEngine.KeyStatus.Down && code === 'ArrowDown') {
                parentTransform.velocity.y = raquetteSpeed;
            } else {
                parentTransform.velocity.y = 0;
            }
        });

        const pingPongBall = new SparkEngine.GameObject();
        const resetBall = () => {
            pingPongBall.transform.size = { width: 10, height: 10 };
            pingPongBall.transform.position = new SparkEngine.Vec2(140, 70);
            pingPongBall.transform.velocity = new SparkEngine.Vec2(3, 5);
            pingPongBall.material.diffuseColor = new SparkEngine.Rgb(255, 0, 0);
        }

        resetBall();


        const pingPongBB = new SparkEngine.BoundingBoxComponent()
        pingPongBB.matchContainerTransform = true;
        pingPongBall.addComponent(pingPongBB);


        const rightGoal = new SparkEngine.StaticObject();
        rightGoal.transform.size = { width: 10, height: 200 };
        rightGoal.transform.position = new SparkEngine.Vec2(299);
        rightGoal.boundingBox.matchContainerTransform = true;
        rightGoal.material.diffuseColor = new SparkEngine.Rgb(255, 125, 0);

        const leftGoal = new SparkEngine.StaticObject();
        leftGoal.transform.size = { width: 10, height: 200 };
        leftGoal.transform.position = new SparkEngine.Vec2(-9);
        leftGoal.boundingBox.matchContainerTransform = true;
        leftGoal.material.diffuseColor = new SparkEngine.Rgb(255, 125, 0);

        renderSystem.registerComponent(leftRaquette.shape);
        renderSystem.registerComponent(rightRaquette.shape);
        renderSystem.registerComponent(pingPongBall.shape);
        // Uncomment to debug world bounding box
        // renderSystem.registerComponent(worldBoundingBox.shape);
        // Uncomment to debug left goal
        renderSystem.registerComponent(rightGoal.shape);
        // Uncomment to debug right goal
        renderSystem.registerComponent(leftGoal.shape);

        physicsSystem.registerComponent(leftRaquette.boundingBox);
        physicsSystem.registerComponent(rightRaquette.boundingBox);
        physicsSystem.registerComponent(pingPongBB);
        physicsSystem.registerComponent(worldBoundingBox.boundingBox);
        physicsSystem.registerComponent(rightGoal.boundingBox);
        physicsSystem.registerComponent(leftGoal.boundingBox);

        hierarchySystem.registerComponent(rightRaquette.transform);
        hierarchySystem.registerComponent(leftRaquette.transform);
        hierarchySystem.registerComponent(pingPongBall.transform);
        hierarchySystem.registerComponent(worldBoundingBox.transform);
        hierarchySystem.registerComponent(rightGoal.transform);
        hierarchySystem.registerComponent(leftGoal.transform);

        pingPongBB.onCollisionCb = ({ collider, postSimulation }) => {
            pingPongBall.transform.position.x = postSimulation.aabb[0];
            pingPongBall.transform.position.y = postSimulation.aabb[1];
            pingPongBall.transform.velocity = postSimulation.velocity;
        }

        rightGoal.boundingBox.onCollisionCb = ({ collider }) => {
            if (collider.uuid === pingPongBB.uuid) {
                resetBall();
            }
        }

        leftGoal.boundingBox.onCollisionCb = ({ collider }) => {
            if (collider.uuid === pingPongBB.uuid) {
                resetBall();
            }
        }

        const drawFrame = () => {
            inputSystem.update();
            hierarchySystem.update();

            physicsSystem.update();
            physx.simulate();

            renderSystem.update();
            renderer.endFrame(context);
        }

        setInterval(drawFrame, 33);
    </script>
</body>

</html>